name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - { os: ubuntu-latest,  name: Linux,                sanitizers: false }
          - { os: macos-latest,   name: macOS,                sanitizers: false }
          - { os: ubuntu-latest,  name: "Linux (sanitizers)", sanitizers: true  }
    runs-on: ${{ matrix.os }}
    name: ${{ matrix.name }}
    steps:
      - uses: actions/checkout@v4
      - name: Install deps (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libsqlite3-dev
      - name: Configure
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Debug \
            -DENABLE_SANITIZERS=${{ matrix.sanitizers && 'ON' || 'OFF' }} \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5
      - name: Build
        run: cmake --build build --parallel
      - name: Unit tests
        env:
          ASAN_OPTIONS: detect_leaks=0
        run: ctest --test-dir build -R unit_tests --output-on-failure --timeout 180

  static-analysis:
    runs-on: ubuntu-latest
    name: Static Analysis
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev cppcheck
      - name: Configure (generate compile_commands.json)
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5
      - name: Build (needed for FetchContent headers)
        run: cmake --build build --parallel
      - name: Run cppcheck
        run: |
          cppcheck --enable=warning,performance,portability \
            --suppress=missingInclude \
            --suppress=unusedFunction \
            --suppress=duplicateAssignExpression \
            --inline-suppr \
            --project=build/compile_commands.json \
            --error-exitcode=1 \
            -i build/_deps \
            2>&1

  regtest-tests:
    runs-on: ubuntu-latest
    name: Regtest Integration
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y libsqlite3-dev
      - name: Download Bitcoin Core 28.1
        run: |
          wget -q https://bitcoincore.org/bin/bitcoin-core-28.1/bitcoin-28.1-x86_64-linux-gnu.tar.gz
          tar xzf bitcoin-28.1-x86_64-linux-gnu.tar.gz
          sudo install -m 0755 bitcoin-28.1/bin/bitcoind bitcoin-28.1/bin/bitcoin-cli /usr/local/bin/
      - name: Configure regtest
        run: |
          mkdir -p ~/.bitcoin
          cat > ~/.bitcoin/bitcoin.conf <<CONF
          regtest=1
          server=1
          rpcuser=rpcuser
          rpcpassword=rpcpass
          fallbackfee=0.00001
          [regtest]
          rpcport=18443
          CONF
      - name: Start bitcoind
        run: |
          bitcoind -regtest -daemon
          sleep 3
          bitcoin-cli -regtest createwallet "test"
          bitcoin-cli -regtest -generate 101 > /dev/null
      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          cmake --build build --parallel
      - name: Regtest tests
        run: |
          cd build && ./test_superscalar --regtest
      - name: Stop bitcoind
        if: always()
        run: bitcoin-cli -regtest stop 2>/dev/null || true

  coverage:
    runs-on: ubuntu-latest
    name: Coverage
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y libsqlite3-dev lcov
      - name: Build with coverage
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          cmake --build build --parallel
      - name: Run tests
        run: ctest --test-dir build -R unit_tests --output-on-failure --timeout 180
      - name: Generate coverage report
        run: |
          cd build
          lcov --capture --directory . --output-file coverage.info \
               --ignore-errors mismatch --ignore-errors unused
          lcov --remove coverage.info '*/build/_deps/*' '/usr/*' '*/tests/*' \
               --output-file filtered.info --ignore-errors unused
          genhtml filtered.info --output-directory coverage_report/ \
               --ignore-errors unused
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build/coverage_report/

  fuzz:
    runs-on: ubuntu-latest
    name: Fuzz Testing
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev clang
      - name: Build fuzz targets
        run: |
          CC=clang cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_FUZZING=ON \
            -DCMAKE_POLICY_VERSION_MINIMUM=3.5
          cmake --build build --parallel --target fuzz_wire_recv fuzz_wire_parse_json \
            fuzz_tx_sighash fuzz_persist_load fuzz_hex_decode
      - name: Run fuzz (5 min each)
        run: |
          cd build
          for target in fuzz_wire_recv fuzz_wire_parse_json fuzz_tx_sighash \
                        fuzz_persist_load fuzz_hex_decode; do
              mkdir -p corpus/$target
              timeout 300 ./$target corpus/$target/ -max_total_time=300 || true
          done
